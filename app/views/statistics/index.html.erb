<% content_for :full_width, true %>
<div class="min-h-screen bg-slate-50">
  <!-- Top Bar -->
  <header class="border-b border-slate-200 bg-white/70 backdrop-blur">
    <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <div>
        <h1 class="text-xl font-semibold text-slate-900">
          Coffee Stats
        </h1>
        <p class="mt-1 text-xs text-slate-500">
          How caffeinated have you been lately?
          <% if @first_entry_date %>
            <span class="inline-block ml-1 rounded-full bg-slate-100 px-2 py-0.5 text-[11px] font-medium text-slate-500">
              since <%= @first_entry_date.to_fs(:long) %>
            </span>
          <% end %>
        </p>
      </div>

      <div class="flex items-center gap-2 text-xs text-slate-500">
        <span class="inline-flex items-center gap-1 rounded-full bg-emerald-50 px-2 py-1 font-medium text-emerald-700">
          <span class="text-[10px]">‚óè</span>
          Tracking active
        </span>
        <%= link_to "Back to logbook", logbooks_path,
              class: "rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-medium text-slate-700 hover:bg-slate-50" %>
      </div>
    </div>
  </header>

  <!-- Content -->
  <main class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 py-6 space-y-8">
    <!-- KPI Row -->
    <section>
      <div class="grid gap-3 sm:grid-cols-4">
        <!-- Today -->
        <div class="rounded-2xl bg-white shadow-sm border border-slate-100 px-4 py-3 flex flex-col justify-between">
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Today</span>
            <span class="text-[10px] rounded-full bg-slate-100 px-2 py-0.5 text-slate-500">Day</span>
          </div>
          <div class="flex items-baseline gap-1">
            <span class="text-2xl font-semibold text-slate-900"><%= @today %></span>
            <span class="text-xs text-slate-400">cups</span>
          </div>
        </div>

        <!-- This Week -->
        <div class="rounded-2xl bg-white shadow-sm border border-slate-100 px-4 py-3 flex flex-col justify-between">
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs font-medium text-slate-500 uppercase tracking-wide">This week</span>
            <span class="text-[10px] rounded-full bg-slate-100 px-2 py-0.5 text-slate-500">Week</span>
          </div>
          <div class="flex items-baseline gap-1">
            <span class="text-2xl font-semibold text-slate-900"><%= @this_week %></span>
            <span class="text-xs text-slate-400">cups</span>
          </div>
        </div>

        <!-- This Month -->
        <div class="rounded-2xl bg-white shadow-sm border border-slate-100 px-4 py-3 flex flex-col justify-between">
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs font-medium text-slate-500 uppercase tracking-wide">This month</span>
            <span class="text-[10px] rounded-full bg-slate-100 px-2 py-0.5 text-slate-500">Month</span>
          </div>
          <div class="flex items-baseline gap-1">
            <span class="text-2xl font-semibold text-slate-900"><%= @this_month %></span>
            <span class="text-xs text-slate-400">cups</span>
          </div>
        </div>

        <!-- Total -->
        <div class="rounded-2xl bg-amber-50 shadow-sm border border-amber-100 px-4 py-3 flex flex-col justify-between">
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs font-medium text-amber-700 uppercase tracking-wide">All time</span>
            <span class="text-[10px] rounded-full bg-amber-100 px-2 py-0.5 text-amber-700">Legacy</span>
          </div>
          <div class="flex items-baseline gap-1">
            <span class="text-2xl font-semibold text-amber-800"><%= @total %></span>
            <span class="text-xs text-amber-600">cups logged</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Main Grid -->
    <section class="grid gap-6 lg:grid-cols-3">
      <!-- Left: Charts -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Cups per Day -->
        <div class="rounded-2xl bg-white shadow-sm border border-slate-100 p-4">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h2 class="text-sm font-semibold text-slate-900">
                Last 14 days
              </h2>
              <p class="text-xs text-slate-500">
                Daily coffee activity
              </p>
            </div>
            <span class="rounded-full bg-slate-50 px-2 py-1 text-[11px] text-slate-500">
              Line chart
            </span>
          </div>
          <div>
            <%= line_chart @cups_per_day,
                height: "224px", # entspricht h-56, optional
                library: {
                legend: { display: false },
                scales: {
                    y: { beginAtZero: true }
                }
            } %>
          </div>
        </div>

        <!-- Cups per Month -->
        <div class="rounded-2xl bg-white shadow-sm border border-slate-100 p-4">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h2 class="text-sm font-semibold text-slate-900">
                Last 6 months
              </h2>
              <p class="text-xs text-slate-500">
                Longer-term trends
              </p>
            </div>
            <span class="rounded-full bg-slate-50 px-2 py-1 text-[11px] text-slate-500">
              Bars
            </span>
          </div>
          <div>
            <%= column_chart @cups_per_month,
                  height: "224px",
                  library: {
                    scales: {
                      y: { beginAtZero: true }
                    }
                  } %>
          </div>
        </div>
        <div class="rounded-2xl bg-white shadow-sm border border-slate-100 p-4">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h2 class="text-sm font-semibold text-slate-900">
                Avg cups by package size
              </h2>
              <p class="text-xs text-slate-500">
                250g vs. 500g comparison
              </p>
            </div>
            <span class="rounded-full bg-slate-50 px-2 py-1 text-[11px] text-slate-500">
              Bars
            </span>
          </div>
  
          <%= column_chart @avg_cups_by_size_chart,
                height: "224px",
                library: {
                  scales: {
                    y: { beginAtZero: true }
                  }
                } %>
        </div>
        <!-- Cups per Package (Chart) -->
        <% if @cups_per_package_chart.present? %>
          <div class="rounded-2xl bg-white shadow-sm border border-slate-100 p-4">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h2 class="text-sm font-semibold text-slate-900">
                  Cups per package
                </h2>
                <p class="text-xs text-slate-500">
                  Only fully consumed bags (open one is ignored)
                </p>
              </div>
              <span class="rounded-full bg-slate-50 px-2 py-1 text-[11px] text-slate-500">
                Bars
              </span>
            </div>

            <%= column_chart @cups_per_package_chart,
                  height: "224px",
                  library: {
                    scales: {
                      y: { beginAtZero: true }
                    }
                  } %>
          </div>
        <% end %>

      </div>



      <!-- Right: Types & little insights -->
      <div class="space-y-6">
        <!-- Cups by Type -->
        <div class="rounded-2xl bg-white shadow-sm border border-slate-100 p-4">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h2 class="text-sm font-semibold text-slate-900">
                By type
              </h2>
              <p class="text-xs text-slate-500">
                What you actually drink
              </p>
            </div>
          </div>

          <% if @cups_by_type.present? %>
            <ul class="space-y-2">
              <% @cups_by_type.each_with_index do |(type, count), index| %>
                <li class="flex items-center justify-between rounded-xl border border-slate-100 bg-slate-50/60 px-3 py-2">
                  <div class="flex items-center gap-2">
                    <span class="text-[10px] inline-flex h-5 w-5 items-center justify-center rounded-full bg-white border border-slate-200 text-slate-500">
                      <%= index + 1 %>
                    </span>
                    <span class="text-xs font-medium text-slate-800">
                      <%= type.presence || "Unknown" %>
                    </span>
                  </div>
                  <span class="text-xs font-semibold text-slate-900">
                    <%= count %>
                  </span>
                </li>
              <% end %>
            </ul>
          <% else %>
            <p class="text-xs text-slate-400">
              No coffee types yet. Go get a cup. ‚òï
            </p>
          <% end %>
        </div>

    <!-- Cups per Package (Liste + Durchschnitt) -->
      <% if @packages_detailed.present? %>
        <div class="rounded-2xl bg-white shadow-sm border border-slate-100 p-4">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h2 class="text-sm font-semibold text-slate-900">
                Cups per package
              </h2>
              <p class="text-xs text-slate-500">
                How far each bag gets you
              </p>
            </div>
          </div>

        <ul class="space-y-2">
          <% @packages_detailed.each do |pack| %>
            <li class="flex items-center justify-between rounded-xl border border-slate-100 bg-slate-50/60 px-3 py-2">
              <div class="flex flex-col">
                <span class="text-xs font-medium text-slate-800">
                  <%= pack[:cup_type] %> ‚Äî <%= pack[:size] %>g
                </span>
                <span class="text-[11px] text-slate-500">
                  opened <%= I18n.l(pack[:opened_at].to_date) %>
                </span>
              </div>
              <div class="text-right">
                <span class="text-xs font-semibold text-slate-900">
                  <%= pack[:coffees] %> cups
                </span>
              </div>
            </li>
          <% end %>
        </ul>

        <% if @avg_cups_by_size.present? %>
          <div class="mt-3 pt-3 border-t border-slate-200">
            <p class="text-[11px] font-medium text-slate-500 mb-1">
              Averages by size
            </p>
            <div class="space-y-1">
              <% @avg_cups_by_size.each do |size, data| %>
                <div class="flex items-center justify-between text-[11px] text-slate-500">
                  <span><%= size %>g</span>
                  <span>
                    <%= data[:avg_cups].round(1) %> cups
                    <span class="text-[10px] text-slate-400">
                      ¬∑ <%= data[:packages] %> packages
                    </span>
                  </span>
                </div>
              <% end %>
            </div>
          </div>
          <% else %>
          <p class="text-xs text-slate-400">
            No packages tracked yet. Log your next bag opening as a package with size. ‚òïüì¶
          </p>
          <% end %>
      </div>
    <% end %>
        <!-- Little note / flavor card -->
        <div class="rounded-2xl bg-slate-900 text-slate-50 p-4 shadow-sm">
          <p class="text-xs font-medium uppercase tracking-wide text-slate-400 mb-1">
            Tiny observation
          </p>
          <p class="text-sm leading-relaxed">
            This page isn't about judging your caffeine habits.
            It's just here to whisper:
            <span class="font-semibold">
              ‚ÄúHey, this is who you‚Äôve been lately.‚Äù
            </span>
          </p>
          <p class="mt-3 text-[11px] text-slate-400">
            Check in once in a while. Or ignore it completely. Both are fine.
          </p>
        </div>
      </div>
    </section>
  </main>
</div>